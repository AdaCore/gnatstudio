@SET_MAKE@

CC              = @CC@
LN              = @LN@
MKDIR           = mkdir -p
STRIP           = strip
INSTALL         = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA    = @INSTALL_DATA@
BUILTIN_PS      = @BUILTIN_PS@
prefix          = @prefix@
bindir          = $(prefix)/bin

CFLAGS     = -g -O2
C_OBJECTS  = ../gnat/gexpect.o ../gnat/gexpect_tty.o ../pixmaps/pixmaps.o
GTK_LIBS   = @GTK_LIBS@
GTK_CFLAGS = @GTK_CFLAGS@
TARGET_CFLAGS = @TARGET_CFLAGS@
TARGET_LFLAGS = @TARGET_LFLAGS@
ALL_CFLAGS = $(CFLAGS) -gnata -gnatwuwe $(GTK_CFLAGS) $(TARGET_CFLAGS) -I../gnat
LINK_FLAGS = $(C_OBJECTS) $(TARGET_LFLAGS) $(GTK_LIBS)
ADALIB = $(strip $(shell gnatls -v | grep adalib))

MAIN = gvd_main
EXEC = gvd

PKG_FILES=${wildcard *_pkg.adb}

all: $(EXEC)

stylechk: pkg_files style

style:
	make CFLAGS="-gnaty $(CFLAGS)" $(EXEC)

pkg_files: ${PKG_FILES}

${PKG_FILES}: force
	$(CC) -c $(ALL_CFLAGS) $@

$(EXEC): gvd-proc_utils-builtin.adb force
	gnatmake -m $(ALL_CFLAGS) $(MAIN) -o $(EXEC) -bargs -E \
	  -largs $(LINK_FLAGS)

gvd-proc_utils-builtin.adb: gvd-proc_utils-builtin_${BUILTIN_PS}.adb Makefile
	$(LN) gvd-proc_utils-builtin_${BUILTIN_PS}.adb \
	      gvd-proc_utils-builtin.adb

libgvd:
	rm -f $(EXEC)
	$(CC) -c $(ALL_CFLAGS) gvd-api.adb
	gnatmake -m $(ALL_CFLAGS) $(MAIN) -o $(EXEC) -bargs -E -n \
	  -largs --LINK=true
	ar cr libgvd.a $(C_OBJECTS) b~$(MAIN).o gvd-api.o \
	  `grep '   --   ' b~$(MAIN).adb | grep '\.o$$' | sed 's/   --   //'`

gvd_test: gvd_test.o libgvd
	$(CC) -o gvd_test gvd_test.o $(GTK_LIBS) -L. -lgvd -L$(ADALIB) -lgnat

gvd_test.o: gvd_test.c gvd-api.h
	$(CC) -c $(CFLAGS) `gtk-config --cflags` gvd_test.c

install: $(EXEC)
	$(MKDIR) $(bindir)
	$(STRIP) $(EXEC)
	$(INSTALL_PROGRAM) $(EXEC) $(bindir)

clean:
	-$(RM) *.o
	-$(RM) *.ali
	-$(RM) *~
	-$(RM) b~*
	-$(RM) $(EXEC)
	-$(RM) libgvd.a
	-$(RM) gvd_test

mostlyclean: clean

distclean: mostlyclean
	-$(RM) Makefile
	-$(RM) gvd-proc_utils-builtin.adb

maintainer-clean: distclean

force:
