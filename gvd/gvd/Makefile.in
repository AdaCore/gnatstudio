@SET_MAKE@

MKDIR           = mkdir -p
STRIP           = strip
INSTALL         = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA    = @INSTALL_DATA@
prefix          = @prefix@
bindir          = $(prefix)/bin

CFLAGS = -g -O2
C_OBJECTS = ../gnat/gexpect.o ../gnat/gexpect_tty.o ../pixmaps/pixmaps.o
GTK_LIBS = @GTK_LIBS@
ALL_CFLAGS = $(CFLAGS) -gnata -gnatwuwe @GTK_CFLAGS@ @TARGET_CFLAGS@ -I../gnat
LINK_FLAGS = $(C_OBJECTS) @TARGET_LFLAGS@ $(GTK_LIBS)
ADALIB = $(strip $(shell gnatls -v | grep adalib))

MAIN = gvd_main
EXEC = gvd

PKG_FILES=${wildcard *_pkg.adb}

all: $(EXEC)

stylechk: pkg_files style

style: force
	make CFLAGS="-gnaty $(CFLAGS)"

pkg_files: ${PKG_FILES}

${PKG_FILES}: force
	gcc -c $(ALL_CFLAGS) $@

$(EXEC): force
	gnatmake -m $(ALL_CFLAGS) $(MAIN) -o $(EXEC) -bargs -E \
	  -largs $(LINK_FLAGS)

libgvd:
	rm -f $(EXEC)
	gcc -c $(ALL_CFLAGS) gvd-api.adb
	gnatmake -m $(ALL_CFLAGS) $(MAIN) -o $(EXEC) -bargs -E -n \
	  -largs --LINK=true
	ar r libgvd.a $(C_OBJECTS) b~$(MAIN).o gvd-api.o \
	  `grep '   --   ' b~$(MAIN).adb | grep '\.o$$' | sed 's/   --   //'`

gvd_test: gvd_test.o libgvd
	gcc -o gvd_test gvd_test.o $(GTK_LIBS) -L. -lgvd -L$(ADALIB) -lgnat

gvd_test.o: gvd_test.c gvd-api.h
	gcc -c $(CFLAGS) `gtk-config --cflags` gvd_test.c

install: $(EXEC)
	$(MKDIR) $(bindir)
	$(STRIP) $(EXEC)
	$(INSTALL_PROGRAM) $(EXEC) $(bindir)

clean:
	rm -f *.o *.ali *~ b~* $(EXEC)

force:
